# .github/workflows/discord-notify.yml

name: Discord Notification

on:
  push:
    branches: ["**"]            # Every branch push
  pull_request:
    types: [opened, closed, reopened, synchronize]
  issues:
    types: [opened, closed, reopened]
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ Push Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” Push
        if: github.event_name == 'push'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -c 200 | sed 's/"/\\"/g')
          BRANCH="${GITHUB_REF#refs/heads/}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          REPO="${{ github.repository }}"

          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸ”€ New Push to ${REPO}\",
                \"description\": \"**Branch:** \`${BRANCH}\`\n**Author:** ${AUTHOR}\n\n\`\`\`${COMMIT_MSG}\`\`\`\",
                \"url\": \"${COMMIT_URL}\",
                \"color\": 3066993,
                \"footer\": { \"text\": \"Predictive Activation â€¢ Push Event\" },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

      # â”€â”€ Pull Request Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” Pull Request
        if: github.event_name == 'pull_request'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PR_TITLE=$(echo '${{ github.event.pull_request.title }}' | sed 's/"/\\"/g')
          PR_ACTION="${{ github.event.action }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Colour: green=opened, purple=merged/closed, blue=synced
          case "$PR_ACTION" in
            opened|reopened) COLOR=3066993 ;;
            closed)          COLOR=10181046 ;;
            *)               COLOR=3447003 ;;
          esac

          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸ“‹ PR #${PR_NUM} ${PR_ACTION}: ${PR_TITLE}\",
                \"description\": \"**Author:** ${PR_AUTHOR}\",
                \"url\": \"${PR_URL}\",
                \"color\": ${COLOR},
                \"footer\": { \"text\": \"Predictive Activation â€¢ Pull Request\" },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

      # â”€â”€ Issue Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” Issue
        if: github.event_name == 'issues'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          ISSUE_TITLE=$(echo '${{ github.event.issue.title }}' | sed 's/"/\\"/g')
          ISSUE_ACTION="${{ github.event.action }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_NUM="${{ github.event.issue.number }}"

          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸ› Issue #${ISSUE_NUM} ${ISSUE_ACTION}: ${ISSUE_TITLE}\",
                \"url\": \"${ISSUE_URL}\",
                \"color\": 15105570,
                \"footer\": { \"text\": \"Predictive Activation â€¢ Issue\" },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

      # â”€â”€ Release Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord â€” Release
        if: github.event_name == 'release'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          REL_NAME=$(echo '${{ github.event.release.name }}' | sed 's/"/\\"/g')
          REL_URL="${{ github.event.release.html_url }}"

          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸš€ Release ${TAG}: ${REL_NAME}\",
                \"url\": \"${REL_URL}\",
                \"color\": 15844367,
                \"footer\": { \"text\": \"Predictive Activation â€¢ Release\" },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
